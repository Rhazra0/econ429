left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
View(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
serial_pernum = paste0(serial,"_",pernum),
reel_pageno = paste0(reel,"_",pageno),
neighupbplnt = ifelse(reel_pageno==L(reel_pageno,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno==L(reel_pageno,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(countynhg,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(countynhg) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,countynhg,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+countynhg+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enatupbar = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enatdownubar=0,
seg = (enatupbar - numneighnative)/(enatupbar-enatdownubar)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
rm(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
serial_pernum = paste0(serial,"_",pernum),
reel_pageno = paste0(reel,"_",pageno),
neighupbplnt = ifelse(reel_pageno==L(reel_pageno,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno==L(reel_pageno,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(countynhg,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(countynhg) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,countynhg,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+countynhg+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enatupbar = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enatdownubar=0,
seg = (enatupbar - numneighnative)/(enatupbar-enatdownubar)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
View(seg1860)
feols(seg ~ seg2,seg1860)
feols(seg ~ seg2,seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
serial_pernum = paste0(serial,"_",pernum),
reel_pageno = paste0(reel,"_",pageno),
neighupbplnt = ifelse(reel_pageno==L(reel_pageno,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno==L(reel_pageno,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(gisjoin_1860,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(gisjoin_1860) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,gisjoin_1860,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+gisjoin_1860+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enatupbar = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enatdownubar=0,
seg = (enatupbar - numneighnative)/(enatupbar-enatdownubar)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
feols(seg ~ seg2,seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
fmutate(serial_pernum = paste0(serial,"_",pernum),reel_pageno = paste0(reel,"_",pageno)) %>%
fgroup_by(reel_pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup()
View(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50)))
View(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50)))
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(gisjoin_1860,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(gisjoin_1860) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,gisjoin_1860,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+gisjoin_1860+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enatupbar = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enatdownubar=0,
seg = (enatupbar - numneighnative)/(enatupbar-enatdownubar)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(gisjoin_1860,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(gisjoin_1860) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,gisjoin_1860,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+gisjoin_1860+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enatupbar = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enatdownubar=0,
seg = (enatupbar - numneighnative)/(enatupbar-enatdownubar)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
rm(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(gisjoin_1860,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(gisjoin_1860) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,gisjoin_1860,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+gisjoin_1860+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enatupbar = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enatdownubar=0,
seg = (enatupbar - numneighnative)/(enatupbar-enatdownubar)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
feols(seg ~ seg2,seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(gisjoin_1860,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(gisjoin_1860) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,gisjoin_1860,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+gisjoin_1860+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enatupbar = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enatdownubar=0,
seg = (enatupbar - numneighnative)/(enatupbar-enatdownubar)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
View(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(gisjoin_1860,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(gisjoin_1860) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,gisjoin_1860,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+gisjoin_1860+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enumnativehigh = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enumnotherhigh = numhas2neigh*(1- ((numhhbybpl-1)/(numhhall-1))*((numhhbybpl-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhbybpl-1)/(numhhall-1))),
enumnativelow=0, enumotherlow=0,
seg = (enumnativehigh - numneighnative)/(enumnativehigh-enumnativelow),
seg = (enumnativehigh - numneighnative)/(enumnativehigh-enumnativelow)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
rm(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(gisjoin_1860,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(gisjoin_1860) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,gisjoin_1860,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+gisjoin_1860+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enumnativehigh = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enumnothanyhigh = numhas2neigh*(1- ((numhhbybpl-1)/(numhhall-1))*((numhhbybpl-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhbybpl-1)/(numhhall-1))),
enumnativelow=0, enumothanylow=0,
seg = (enumnativehigh - numneighnative)/(enumnativehigh-enumnativelow),
seg2b = (enumnothanyhigh - numneighothany)/(enumnothanyhigh-enumothanylow)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
feols(seg ~ seg2, seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
numneighnative = as.numeric(neighupbplnt==99 | neighupbplnt==99),
numneighothany = as.numeric(bplnt!=neighupbplnt | bplnt!=neighupbplnt),
numhas1neigh= as.numeric(is.na(neighupbplnt) | is.na(neighdownbplnt)),
numhas2neigh= as.numeric(!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
group_by(gisjoin_1860,bplnt) %>% mutate(numhhbybpl=sum(all)) %>% ungroup() %>% filter(numhhbybpl>1) %>%
group_by(gisjoin_1860) %>% mutate(numhhall=sum(all),numhhmig=sum(as.numeric(bplnt>99))) %>% ungroup() %>%
select(statefip,countyicp,year,gisjoin_1860,bplnt,numhhall,numhhmig,numhhbybpl=all,numneighnative,numneighothany,numhas1neigh,numhas2neigh) %>%
collap(~statefip+countyicp+gisjoin_1860+bplnt+numhhall+numhhmig,fsum)  %>%
mutate(enumnativehigh = numhas2neigh*(1- ((numhhmig-1)/(numhhall-1))*((numhhmig-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhmig-1)/(numhhall-1))),
enumnothanyhigh = numhas2neigh*(1- ((numhhbybpl-1)/(numhhall-1))*((numhhbybpl-2)/(numhhall-2))) + numhas1neigh*(1- ((numhhbybpl-1)/(numhhall-1))),
enumnativelow=0, enumothanylow=0,
seg = (enumnativehigh - numneighnative)/(enumnativehigh-enumnativelow),
segfb = (enumnothanyhigh - numneighothany)/(enumnothanyhigh-enumothanylow)) %>%
filter(bplnt!=99) %>%
left_join(read_dta("/Users/mgebresilasse/Downloads/109662-V2 2/segmeasures.dta") %>% filter(year==1860) %>%
select(statefip,countyicp=county,bplnt=bpl,seg2,seg2FB,seg2_max),
by=c("statefip","countyicp","bplnt"))
feols(segfb ~ seg2FB, seg1860)
feols(seg ~ seg2, seg1860)
View(full1860)
rm(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt))) %>%
select(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
select(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh)
collap(~gisjoin_1860, fsum) %>%
rename_at(vars(matches("native|migrant")), ~ paste0("nhh",.))
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
select(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh)
collap(~gisjoin_1860, fsum)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
select(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh) %>%
collap(~gisjoin_1860, fsum)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
select(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh) %>%
collap(~gisjoin_1860, fsum) %>%
rename_at(vars(matches("native|migrant")), ~ paste0("nhh",.))
View(seg1860)
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
fselect(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh) %>%
collap(~gisjoin_1860, fsum) %>%
rename_at(vars(matches("native|migrant")), ~ paste0("nhh",.)) %>%
fmutate(enhhmigranthigh = nhhmigranthas2neigh*(1- ((nhhmigrant-1)/(nhhall-1))*((nhhmigrant-2)/(nhhall-2))) + nhas1neigh*(1- ((nhhmigrant-1)/(nhhall-1))),
enhhmigrantlow=0,
segmignat = (enumnativehigh - numneighnative)/(enumnativehigh-enumnativelow))
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
fselect(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh) %>%
collap(~gisjoin_1860, fsum) %>%
rename_at(vars(matches("all|native|migrant")), ~ paste0("nhh",.)) %>%
fmutate(enhhmigranthigh = nhhmigranthas2neigh*(1- ((nhhmigrant-1)/(nhhall-1))*((nhhmigrant-2)/(nhhall-2))) + nhas1neigh*(1- ((nhhmigrant-1)/(nhhall-1))),
enhhmigrantlow=0,
segmignat = (enumnativehigh - numneighnative)/(enumnativehigh-enumnativelow))
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
fselect(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh) %>%
collap(~gisjoin_1860, fsum) %>%
rename_at(vars(matches("all|native|migrant")), ~ paste0("nhh",.)) %>%
fmutate(enhhmigranthigh = nhhmigranthas2neigh*(1- ((nhhmigrant-1)/(nhhall-1))*((nhhmigrant-2)/(nhhall-2))) + nhhmigranthas1neigh*(1- ((nhhmigrant-1)/(nhhall-1))),
enhhmigrantlow=0,
segmignat = (enumnativehigh - numneighnative)/(enumnativehigh-enumnativelow))
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1 & statefip==1 ) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
fselect(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh) %>%
collap(~gisjoin_1860, fsum) %>%
rename_at(vars(matches("all|native|migrant")), ~ paste0("nhh",.)) %>%
fmutate(enhhmigranthigh = nhhmigranthas2neigh*(1- ((nhhmigrant-1)/(nhhall-1))*((nhhmigrant-2)/(nhhall-2))) + nhhmigranthas1neigh*(1- ((nhhmigrant-1)/(nhhall-1))),
enhhmigrantlow=0,
segmignat = (enhhmigranthigh - nhhmigranthasneighnative)/(enhhmigranthigh-enhhmigrantlow))
seg1860 %>% ggplot() + geom_histogram(aes(segmignat))
seg1860 <- full1860 %>%
#mutate(gisjoin_1860_new = paste0(G, str_pad(countynhg*10,3,pad="0")))
filter(!is.na(bpl) & !is.na(countynhg) & gq==1 & pernum==1) %>%
#arrange(reel,pageno,line,serial,pernum) %>%
fgroup_by(reel,pageno) %>% rowid_to_column("reel_pageno_num") %>% ungroup() %>%
fmutate(reel_pageno_50 = paste0(reel,"_",pageno,"_",floor(reel_pageno_num/50))) %>%
fmutate(all=1,bplnt=ifelse(bpl<=99,99,bpl),
native = as.numeric(bplnt<=99), migrant = as.numeric(bplnt>99),
neighupbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,1),L(bplnt,1),NA),
neighdownbplnt = ifelse(reel_pageno_50==L(reel_pageno_50,-1),L(bplnt,-1),NA),
migranthasneighnative = as.numeric(migrant==1 & (neighupbplnt==99 | neighupbplnt==99)),
nativehasneighmigrant = as.numeric(native==1 & (neighupbplnt>99 | neighupbplnt>99)),
migranthas1neigh= as.numeric(migrant==1 & (is.na(neighupbplnt) | is.na(neighdownbplnt))),
migranthas2neigh= as.numeric(migrant==1 & (!is.na(neighupbplnt) & !is.na(neighdownbplnt)))) %>%
fselect(gisjoin_1860,all,native,migrant,migranthasneighnative,nativehasneighmigrant,migranthas1neigh,migranthas2neigh) %>%
collap(~gisjoin_1860, fsum) %>%
rename_at(vars(matches("all|native|migrant")), ~ paste0("nhh",.)) %>%
fmutate(enhhmigranthigh = nhhmigranthas2neigh*(1- ((nhhmigrant-1)/(nhhall-1))*((nhhmigrant-2)/(nhhall-2))) + nhhmigranthas1neigh*(1- ((nhhmigrant-1)/(nhhall-1))),
enhhmigrantlow=0,
segmignat = (enhhmigranthigh - nhhmigranthasneighnative)/(enhhmigranthigh-enhhmigrantlow))
seg1860 %>% ggplot() + geom_histogram(aes(segmignat))
check <- seg1860 %>% filter(segmignat==0)
check <- seg1860 %>% filter(segmignat<0.1)
View(check)
seg1860 <- seg1860 %>% mutate(segmignat=ifelse(nhhmigrant<=1,NA,segmignat))
check <- seg1860 %>% filter(segmignat<0.1)
seg1860 %>% ggplot() + geom_histogram(aes(segmignat))
x <- 3
x <- 3
x <- "Texas"
z <- c("apple", "orange")
z
w <- list(x, y)
w <- list(x, z)
z2 <- z[2]
z2
w
setwd("/Users/mgebresilasse/Dropbox (Amherst College)/Courses/202324_Spring/Econ429/econ429labs/lab1")
install.packages("tidyverse")
install.packages("pacman")
install.packages("pacman")
?exactextractr
?exactextractr
?tmap
pacman::p_load("tidyverse","sf","tmap","exactextractr","raster")
?tmap
?tm_borders
eth_zonepop_2022_fromRDS <- readRDS("ethiopia_population_by_zone_2022.rds")
View(eth_zonepop_2022_fromRDS)
eth_zonepop_2022 <- read_csv("ethiopia_population_by_zone_2022.csv")
View(eth_zonepop_2022)
?read_dta
?readr
paman::p_load("haven")
pacman::p_load("haven")
?read_dta
select <- dplyr::select
View(eth_zonepop_2022)
ethzonepop <- eth_zonepop_2022 %>%
select(region_name=admin1Name_en,zone_name=admin2Name_en,zone_code=admin2Pcode,
pop_total,pop_male,pop_female)
sexratio_oromia <- ethzonepop %>%
mutate(sexrat=pop_male/pop_female, pop_male_sq = pop_male^2) %>%
filter(region_name=="Oromia")
View(sexratio_oromia)
zonebound <-  st_read("eth_admbnda_adm2_csa_bofedb_2021.shp")
View(zonebound)
a <- zonebound %>% select(1:3)
View(a)
roads <- readRDS("ethiopia_major_roads.rds")
View(roads)
malmort2020 <- raster("./malaria/202206_Global_Pf_Mortality_Rate_ETH_2020.tiff")
malmort2020 <- raster("./malaria/202206_Global_Pf_Mortality_Rate_ETH_2020.tiff")
st_write(roads, "roads_new.shp")
st_write(roads, "roads_new.shp",append=FALSE)
